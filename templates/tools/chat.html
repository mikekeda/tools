{% extends parent_template %}
{% load i18n %}
{% block content %}
    <h2>Chat with websockets</h2>
    <hr>
      WebSocket status : <span id="message"></span>
    <hr>

    <div id="chat">
      <div class="viewport"></div>
      <form class="row row-chat">
        <div class="input-group">
          <input type="text" class="form-control" placeholder="Type your message" />
          <span class="input-group-btn">
              <button type="submit" class="btn btn-primary">Send</button>
          </span>
        </div>

      </form>
    </div>
    <script type="text/javascript">
      if("undefined" == typeof jQuery) {
        window.onload = function() {
          init_app();
        };
      }
      else {
        init_app();
      }
      function init_app() {
        function wrap_message(msg, $element) {
          var html = '<div class="bubble bubble">' + msg + '</div>';
          html = $.trim(html);
          $element.html($element.html() + html);
        }

        var ws = new WebSocket('ws://127.7.218.129:15888/ws');
        var $message = $('#message');

        ws.onopen = function(){
          $message.attr("class", 'label label-success');
          $message.text('open');
        };
        ws.onmessage = function(ev){
          $message.attr("class", 'label label-info');
          $message.hide();
          $message.fadeIn("slow");
          $message.text('received message');
          var json = JSON.parse(ev.data);
          wrap_message(json.message, $('.viewport'));
        };
        ws.onclose = function(ev){
          $message.attr("class", 'label label-important');
          $message.text('closed');
        };
        ws.onerror = function(ev){
          $message.attr("class", 'label label-warning');
          $message.text('error occurred');
        };

        $("#content").on('click', ".input-group-btn .btn-primary", function(event) {
          var url = '127.7.218.129:15888/api';
          $.post(url, { m: $(this).parent().parent().find('input').val() });
          $(this).parent().parent().find('input').val('');
          return false;
        });
      }
    </script>
{% endblock %}
