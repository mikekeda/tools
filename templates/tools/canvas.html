{% extends parent_template %}
{% load i18n %}

{% block title %}{% trans "Canvas" %}{% endblock %}
{% block description %}{% trans "Online canvas image drawing tool." %}{% endblock description %}

{% block content %}
<style scoped>
  div#div2 {
    position: fixed;
    bottom: 0px;
    padding: 1%;
  }

  div#div3 {
    position: relative;
    background-color: #fff;
    border: 2px solid black;
    max-height: 400px;
    max-width: 300px;
    overflow: auto;
    word-wrap: break-word;
    display: none;
    border-radius: 5px;
  }

  .hide {
    display: none;
  }

  .show {
    display: block;
  }

  div#tool {
    width: 160px;
    height: 567px;
    float: left;
    border: 2px solid black;
    border-radius: 10px;
    padding: 1%;
    margin: 0.5% 0.5% 0.5% 0;
  }

  div#num_canv {
    width: 530px;
    border: 2px solid black;
    border-radius: 10px;
    margin: 0.5%;
    padding: 1%;
    clear: left;
    float: left;
  }

  div#num_canv_control {
    width: 170px;
    border: 2px solid black;
    border-radius: 10px;
    margin: 0.5%;
    padding: 1%;
    float: left;
  }

  div#canv_div {
    background-color: white;
    position: relative;
    border: 2px solid black;
    border-radius: 10px;
    margin: 0.5%;
    float: left;
    cursor: crosshair;
  }

  .form-item {
    margin: 5px 0;
  }

  img#canv_img{
    z-index: -1;
    position: absolute;
    top: 0;
    left: 0;
  }

  input, select {
    font-size: 14px;
    margin: 2px;
  }

  input#send_mes {
    float: right;
  }

  input#canv_width, #alfa {
    width: 100%;
  }

  input#color {
    width: 35%;
  }

  input#width, #height {
    width: 60px;
    float: right;
    clear: both;
  }

  label {
    clear: both;
  }

  button,
  .button {
    background: -moz-linear-gradient(top, #fff, #ddd);
    background: -webkit-linear-gradient(#fff, #ddd);
    background: -o-linear-gradient(top, #fff, #ddd);
    border: 1px solid #bbb;
    border-radius: 5px;
    display: inline-block;
    text-align: center;
    box-shadow: 0 0 .05em rgba(0,0,0,0.2);
    text-decoration: none;
    padding: 2px;
    min-height: 20px;
    min-width: 30px;
    margin: 2px 0;
    font-size: 14px;
  }

  button:hover,
  .button:hover {
    background: -moz-linear-gradient(top, #ddd, #ddd);
    background: -webkit-linear-gradient(#ddd, #ddd);
    background: -o-linear-gradient(top, #ddd, #ddd);
  }

  #content-box .active {
    border:2px solid #777;
    padding: 1px;
  }

  button > img {
    position: relative;
    top: 1px;
  }

  #drawing-tool > button,
  #drawing-modify > button {
    width: 32px;
    height: 32px;
    overflow: hidden;
  }

  button#resize_canv {
    float: right;
  }

  #files,
  #sound {
    position: absolute;
    opacity: 0;
    z-index: 1;
    width: 28px;
    height: 31px;
    margin-left: -26px;
  }

  button > .glyphicon,
  .button > .glyphicon {
    padding: 2px 0 8px;
  }

  button > .glyphicon:before,
  .button > .glyphicon:before {
    color: #555;
    position: relative;
    top: 2px;
  }
</style>

  <div id="div0">
    <div id="tool">
      <div id="drawing-tool">
        <button type="button" id="pencil" class="active"><span class="glyphicon glyphicon-pencil" aria-hidden="true"></span></button>
        <button type="button" id="elastic" class=""><span class="glyphicon glyphicon-erase" aria-hidden="true"></span></button>
        <button type="button" id="line" class=""><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAABmJLR0QA/wD/AP+gvaeTAAAAvUlEQVR42tXVvw6CMBDH8e+VOLE4+BaEzfd/IQdlMChYcDkSQ0D75zrYBbp8fr1C7qDwqgqYArhl44zxEzABNXAApDLGL0CjB38BozPGW2AEvAbMzhh/Aj3Q6Xt2wBZ+BR76LZBCuP/8pYrhqQHBeEpAFB4bEI3HBCThoQHJeEhAFv4rIBv/FmCC7wWY4VvzYMHPwJCLrysQbVCNttweuOnTpzYsWVVTA0cFu5yT783kWQfFXe9/KjWwhX9Zbxf5bIJlM/PAAAAAAElFTkSuQmCC" alt="line"></button>
        <button type="button" id="polyline" class=""><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAAXNSR0IArs4c6QAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9wCBhQNGTxpp2kAAAFXSURBVEjH1ZWxSgNBEIa/TVJF7soh19lq0K0EC8E3UbALmFcSLAQ7izQ+gJDCTom13YRpApekS8RmD46YhLvNNS4cLHPHfPPvzfwL/321i433ftrr9a5brdZrkiSrxWLx0wTAFZssy1LgUkSGRczMboC5qq6aALSBNDx9oCsit4eC3GYgy7IOkAAdoAv0RWQQq8rte1mC/VFVFeaqVLFNVQl2YWYnQK6q6yjAFlgqIo9BxTMwA95UNd/8vlMXICIvIfEQOAOOgAmwjD6i0qyMzGwAnIfQBJiH41lFA7z3o1D1PXAMfAN5lW5yNRL3Q/gDmB7UpjsST6pWvRfgvZ8C72b2FH7cZ0icNzXJKXBVTK+Z3QGzWD/a1qZLYGxmX8CpiDyEeJQfuao2UVLUnBc1AXI1LaI2KNaLKoMckWsXqATLVXUdDdh3ZwR/GqtqfjBgx52xKhT8AtC2ylAa5QcTAAAAAElFTkSuQmCC" alt="polyline"></button>
        <button type="button" id="rectangle" class=""><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAAXNSR0IArs4c6QAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9wCBhQNAFgCD6kAAACdSURBVEjH7ZU9CgIxEIW/3Uk5IOKRtEtv7mifbs/gSQRZSBu0cSGGgLA720heFfLzPSZkXqDr7zUsgxDCyxIcYzwBs6smr4AAeQvce38DzsDkqjUB7sDToAgBXG2QP/BHSmnVlanqULAYW5vWwltnx71fUTfoBjsZFM2ypdEAcI0MsZJ8pamqHoGLRdgVjKk0EOCwOBsoA3P/EX/qDWifI9LKr/WeAAAAAElFTkSuQmCC" alt="line"></button>
        <button type="button" id="circle" class=""><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAAXNSR0IArs4c6QAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9wCBhQPAR0zXb0AAAOtSURBVEjHvZZNaGNVFMd/996XRWchySaFweggzEoMhNmJcZHBNrXMQzp1oDBD1KK0tNSds1EouBB3OptxJ6GELhxI++rQbPooZKUyFLKQupTAYIM02eS7714X773kpR+OIPrgEEh453/u7/7POREPP3vIix4pJUopjDEACCHwPA+t9Qvfta76QQhBIpEgnU6TSqVITieJx+MAtFotGicN6vU6tVqNZrM5Ev9HAlNTU+Tn8qTTaXK5XAG4A9wCbgAD4DnwDNhzXbdYq9Wo7FfodrsXCz2PKJPJkLudw7bt+8CXwEvAE+DXIPE14FXgDeAdoAlsOo5TdA9cjo6Orj5BJpPh7uJdstnsI2AN+A74vFzeaQJobTBGY4zBGMO9e+9fAwrAN7Zt36pWqxvAhIgVxZK7nQuTLwML5fLOLgiM0WjtR5jcGMP29nYHeLy0tPQj8DSbzT5yHGfj+Ph4hEuGF5qfy2PbdgH4BJgvl3d3/ao9PM8LXDOOqGipVKoDM8CibduF/FweIcRYIHQLsAl8US7vHvrJdST55Cl8XOMolUp/AJ8Cm+l0mkQiMRaIuEUB30Yr9xNexAOTtgxs+gTo53K5QlAwUkpJKpUisOL3Ozu7Ax+DjoSf0PM8hsMhvV6PTqdDu92m0+nQ7/cZDodsbW0Z4AfgTiqVQkqJpZQiOZ0k8PljrU0EhR/9/oDBoM/Z2dmoCaWUCCERglERZ2cewM/A/eR0EqUUljEm7NDrwO+hDbX26HZ79Pu9EZ5wbEipUMoX8IVElFYDuB6PxzHGXOhkpbVmOBzSbrfxvLPRZfrJFUr54QtFBcTlo0IIQavVIujSG71e77deL1q1mRh40ZBSIaUYoQqeV4DnrVbLR+l5Ho2TBsFseXswGET4+9ULIc4lt1DKwrIsLCsW+YwBvAk8a5w08DwPqbWmXq8D7AEPlpc/io2tyAT3KKIwLMsiFvNjcXEhBiwAe/V6Ha213we1Wg3XdYuAB3wMBmMYVR+yVkpOiPiVq9EJgA8BHU7YUaM1m02CLzaBr1ZWVl4P2QsRMhbnxHwn+SeIMT8/9xrwNbAZ7oiRgDGGyn4Fx3GKQBF4ura2dnMsICaEpBQTlz47O3MTqABbjuMUK/uVsfNCzt1uF/fAJRi5DvDL+vr6g9XVVSXE5ULz8+/K2dmZD4CfgEq1Wt1wD9yJxfN3C6cQIBsE7V8F/gxG/MvAW8B7wWtXLhxx2dL/T1fm/7L0w4s/PT3l8PDwX/1t+QuIglOW+oSxOgAAAABJRU5ErkJggg==" alt="circle"></button>
        <button type="button" id="pipette" class=""><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAAXNSR0IArs4c6QAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9wCBQ8qLyvQY+oAAALvSURBVEjHrVVPaBRnFP993+6WTSIYmlLiRcGCQlrQ0kKtRBbUi3gr9FL0kkOiXpJNJswmM2TIbiYbwuxsAjmKIgge6rXUnqSHHlV66jnxlHgy5o8z3/ve8+BuiWys2d3+YGDex5v3m/fv9wFdIIqilrPl5eUP7GynwRcWFuA4Dur1+glr7Q0ABOCh4zivDvqpToL7vg9mRn9/fy8R/am1/l5EAOCutfaO7/um4wxqtdqxbDZrNzY29M7Ozl8AzgGQxs9+o5TKA+icgIh+Zea9XC63lyRJM3gTT7XWewf9dbsESZLc393d/Smfz39HRE+ISDWeRwMDA7PVatW2TbC4uPjve19f34ZS6rckSc7mcrmTRPSMiB7VarVftra24DgO2iaYnZ0FACwtLY0w8618Pj+gtf7DGDOUyWS01vo2AFhrW0b3kwRBEAAAwjAcYebBNE2/IqILvb2954noZ2b+VkSGAaBer7d8/1GCUqkEAJifn0cQBFeMMRfTNL1GRMNEtGmM+XF1dfWxtfaMMebJ+Pj4oXE+uQee540AuAjglFLqKoBNpdT1SqXy7CjlPTSDZqNc1x0xxgwS0Vlr7VUi2rXW/nDU4IcSFItFRFEEx3EuE9EFZr7GzMPW2k1r7dfVanXddd0jj3XmoDExMYGVlRVMTU2dB/A7AKuUugRgE8D1KIr+mZ6ebhG0/4I6JIMsgL+VUkONoz0AQ3Ecr3eiWy0lYuabInKG3+M5M5+O43h9cnKyI9Vt0SIR6ReRFwAeMPO9tbW1/WKxiDiO8b9gdHQ0NzY21te0PzbfHfWgUqmgp6dnEMDnIvKSmd+4roswDOF5XvcEDb05DuBLAEpE3gB4NTMzQ42N7r7JmUzmtTFm2xiz05DhL8rlciYIAszNzbVN8MEehGGIUqmEQqHwlpkhIgkzk4h8VigUTLlclq5L1CyF53lKaw0R0Q0/EREbhmF3JQqCAL7vIwxD2d7elv39fZumKVlrbeNibwvvADv2isQFjR/IAAAAAElFTkSuQmCC" alt="pipette"></button>
        <button type="button" id="fill" class=""><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAAXNSR0IArs4c6QAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9wCBQ8fF6HjGcIAAAUuSURBVEjHzVZNTFRXFP7ue/D4icoMiFAEOigjiUWlCfgTSwUUEVFZmAw/QtDYhC4aN000hsSFTWu3TcvCNI2LloypLy74cUFgQSkIBsRkGIqkIzPEAcZxRmYY5s279713u1CIWG3VdNGTnMU9Oec73zknOecC/yeprKx85xjyNk41NTWYmprC7OwsysvLv2WMFSUkJNQSQtS+vr5/jBXeBrynpwdbtmxJPnz48M/79++/1NraWpWcnPxrJBIhAFBdXf1+LTl27BgAoKysLL+6unqgo6ODU0qNaDRqXL9+nR88eLDj/Pnz4nuBHzlyBABQVVVVdvz48aXh4WGuKAr3+Xzc6/XySCRitLe3G3v37v36ypUrOHny5NsB19bWrrImlZWVjY2Njcb09LTBOTcYY5wxxnVd54wxHovFeFtbGz969OjpdxryxYsXxfHx8a9KSkounTt3TrBarWCMYXBwEHNzc9i2bdvzYEJ4MBgkAwMD2qZNm64CmFdVNahp2qIkSTPXrl0LkAsXLggpKSk1ycnJVcvLy38Eg8HfZmZm2k+cOPFJaWkpyc/P58+xCC5fvoyFhQVUVFRg8+bNMJlMSEpK4nFxcUTTNDDGtJWVFX1paYl6PB4SDAbr4nJycj4oKirq3LVrF2ZmZnDjxg3YbDaYTCaelpYGRVHIC7ZoaWlBX18fUlJSsLi4iHv37kFVVWIYBkRRhKIocQCeSJK0oqqqqihKKI4xhlAoBK/Xi46ODhw6dAiCIPCtW7eS+Ph4xGKxtdZlZGSgubkZoihCEASEw2H4fD4sLCwgEonA7XZjYmLi8dOnTytGR0dXAEC0Wq1EFMVKURSzXC4Xn52dJWazmezbt4/HYjGi6zoMw4BhGNB1HS9aAUopBEHAxo0bkZmZCbPZDLPZzFVVzX727FnZqVOnfhkZGdHFsbExdefOnakAKjZs2MD9fv/3d+/ejQHI27FjB6eUktUEr6qu61glkJiYiPT0dFJcXMwVRckdHx9PKyws7BUBYPv27U845y2CICQJghCfnp5eMzExcSAxMdGSnZ3NGWOEc443JTIM4+XKiNVqRTAYLAkEAiERABwOR9BqtX5sMpk+0jQta2lpqU9RlB/cbndVVlZWZmpqKlRVXcf6VX25Ks45z8nJIQ8ePKha20V+v//LQCAASZLAGKvo7Oz0x2Kxs3a73Tc/Pw/OOaeU4t9U13UeDodJV1cXZ4y1CQBgs9lw586dx4FA4Dtd18EYSweArq6uiWg0ekaWZdXv9xNN0zhjDK9TSikAcLfbTex2+7LT6Twry/I3IgA4nU4AQEFBgdMwjC8ikUjP9PT0wJ49ezA4ODhrsVjG/H5/U15eHqGUvhZcEAQ+OTlJ+vv750Oh0Kfd3d39ALBuE2ZnZ2uRSKSCMfajy+Wa8/l8qK+vhyzLf2ZkZNBoNFqemZkJRVHIS23hnHPicDjI0NDQkGEYB27fvu2tq6uD0+lcnyA3NzdB07Q8xphcUFCgulwuTE5OAgAePnz4e3t7exaltNhkMvFoNEoYY5xSSu7fvw+n0/mTKIrNsiwvNzQ04ObNm38/OIZhrBiGcZVzHu7t7V2z19fXgxACSZI+93g89kePHhHGGFcUhYyOjsLr9X6WlJTUKsvyss1mg91uX4tdV4HH44HH42EWiwUej2fNvlpFYWEhKKXd0Wi0VJIky9TUlD8cDp+5deuWfffu3dzhcKzN851u8qvS0NDwIaX0tCRJw3a7feQ//Vk0Njb+7d3U1PRG/78AhXlFq4CdmjIAAAAASUVORK5CYII=" alt="fill"></button>
      </div>
      <hr>
      <div id="drawing-modify">
        <button type="button" id="mir_x" onclick="scale(1,-1);"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAAXNSR0IArs4c6QAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9wBHg4AN5at9+0AAAQjSURBVEjHrVTfSxxXFP7unTszzOzsbDUhO7vudsFVyC7KKhqDCYK2VEIfkpCUPhgwP30QpOxz/4YEfG0CJQ9tfPQhKfQlgRBdn0wQLIIYxM2sirpt3NnV/TE7pw+1G2xNmwQ/OA/3Xu53znd+MRwDFhcX0dHRAQAYHR2VTdP8TNM0pVKpbDAcE4aGhnytra3ftrW1DcZisQuFQuHUzMxMXHwK2eTkJNLpNADg5s2b7X6//+dYLBY9f/78yZaWFlEqlbCysoLNzU3zoxWMj4/7XNf1WZZ1SdO0H1paWtjg4CB0Xac3b94w27ahqipc18W9e/d63qvg0aNHGBkZaZzv3LlzBsCXHR0dX1mW9UUwGEQkEkG1WqX19XXmOA7jnMMwDCiKgrdv3wIA/uXgxo0bePjwYYN8YmLiO1VV0319fSdSqZTp8/lQLBbhOA6tr68zImIAYBhGg0OWZRARiAjiwYMHGBsbazzqut6cTqebAoHA94Zh3Orq6kIqlQIRUT6fRy6XgyRJ4JwzVVVBRIcCZIxBCNG4F2NjY7h48aIeCoUuGIbRl0wmvwkGg/FIJIJwOEz7+/vI5/OsVqsxxtihSN8HId4lRty+fftEMpn8tbOzs/P06dOqJEmo1+uo1WrY3d1lRARJkg59+i8QUSNFACC2trZCV65c6T179izt7e3B87yPIjwKkiQR+wsQlUpFzmazeP78OfM871iGjnPObNsGEdVZU1PTKcuyBqrVqvbPgn0qDgpd2NjYmBWtra27iURiaX9/X8YxwufzVVdWVhxx7ty5yMDAwG/hcBiMMTB2POvJtm28ePGiTeRyOX8kEkFvby9ls1lWKBQghGg4+5S0ybJMAJht235RrVbdpaWlgt/v1+LxuByNRrG9vY1isYh6vd5Q9KHqiAicc0ZE8DyPS8vLy6WnT5/+ks1mc/Pz83nXdS3OuR6NRmFZFqmqCgCMiCCEgBACkiS914QQUBQFhUIBs7Oz9wXnvFQqlRanp6dXAZiPHz9uN03Tunr16ngsFuvv6elBIpEgz/NYPp9HuVz+XzWSJL0btIPerxzYH69fv94CoL969SoD4OT169evtbe3X+vv71e7u7t9wWAQruuiUqlQvV5nR9Xo711ERJCOCKAGYA+AA+D3hYWFuWfPnv20tra2+PLly52dnR1RLpeDuq6zcDgMTdNIkiTGOW+kSJZlbG5uIpPJ3P/QnhQANABGOByOKopiXb58+VIikbgVj8cxNDQEzjkREXNdF5xzZDIZ3L17t0f6QAcegCqAouM4247j5Obm5uaePHny48LCQsa27eTa2ppobm5WNE3jiqLAtu2PUnDkygEgHyjTA4FAfHh4+Ouurq4zqVSqt1wuB6ampnrYMe0eTkQKAJ9pmqdCodDnpmlqq6urmT8BRuy0IP0WGIoAAAAASUVORK5CYII=" alt="flip x"></button>
        <button type="button" id="mir_y" onclick="scale(-1,1);"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAAXNSR0IArs4c6QAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9wBHg4AG6R1mw4AAAOTSURBVEjHlZZLSyNZFMf/595K5WFHE1PmYRKNsRNM+0oiitEgaA89usjYDeoIQmbhwlnouJn1iDAfoMFNb2c+iftZzBAFVwODiAgiRktTwaTqzsYErTzUA5e6VJ06v3vO/9xbRXjBDg4O/rDb7flKpaJeXFwkz87Oyv39/X/LsuzVNO3P/f39n9q9z9s93NnZ+X5xcfH3XC7Hq9Wq9ejo6J/j4+Pi6urqrysrK6JUKiVkWf6rUCj82yoGawfo6OiYGRoasp6enpJhGNA0DZqmyYZhoFAoUDqdtlqt1pl2MVoCNjc3u8fHx3+w2+0oFosgIjDGBAAQEW5ubkBEGBsb+y6Xy7neDNA0zReJRJLX19eQZRkAIISoX202Gy4vLzEwMDDDGAu8GZBMJn/2+/24vb0VkiQ1isc5VFUViqIgFov9+GaA2+3+JRwOAwBxzuurr5kkSRBCUDAYFB6PZ+9NgO3t7c+JRAKqqgrGGDhvbDbGGIgI9/f3iMfj2NjY+PxqgNvt3stkMlBVlTjnYIw1BUiShGKxSJOTk3C5XHuvAuTz+Q9TU1P9RCR0XQfnvCEDIUT9vq7rkGVZpFKp/uXl5Q8vAlwu16dUKtV1dXVFFosFjLGmGdQys1gsOD8/p3Q63eV0Oj+1BaytrTlGR0cXFEVhDw8P9SCtSlTTp1qtwuVysZGRkYWlpSXHs2YwdYY3EonMl8tlSJIEIqqv1txFNQ1q83K5jHA4PM859wL4r2kGfX19Sa/X+04IISRJqq+wnQY1kBBC+Hy+d8FgMNmyRKFQ6Fs8HgcRUS34Sxo86TKKRCLo7e391hSgKIri9/t9VqtVPJ47z4bZzD5EBIfDIXp6enxut1tpAGxtbX3NZrN4eHggc3AzoFYis4+maTQ9PY319fWvZpEtgUBg3ufzCU3TyFzzViUyDOPZPcMwEIlEhNfrnQdgAVBhALC7u/slm812A6CnwtbGo4gNULMf5xylUokymUx3Pp//AgAsGo3yQCDwMRqN2gzDaJp6u31gHrquY3Bw0Ob1ej+GQiEuzc7OKolEYsFms4GImh5stf1g1qCVORwOxGKxhYmJCUVijPV0dna+L5fLDTV9CqhWq/XAuq6jUqlA1/XmH3rO4fF43hNRD83NzUWTyeS+qqoNdX4KcDqd4vDwcF+SJBoeHv7t7u6OhBAN2dXM6XTi5ORkjwBYAXS99IcBQAdw8zh/tf//8tQkYiDN0ikAAAAASUVORK5CYII=" alt=" I "></button>
        <button type="button" id="pan" class=""><span class="glyphicon glyphicon-move" aria-hidden="true"></span></button>
        <button type="button" id="crop" class=""><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAAXNSR0IArs4c6QAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9wCCBYqCRhApjUAAADYSURBVEjH1VU9DoIwGH0Yki8xDtxEVyfgLi7d8CS+jevADTgKg0tjoi7FNKZWqFTxTW3T9mvfTz4gMpLnhaqqtgAyANBatwBQ13VwgdSxRgDFqwcsDolFC2e4ryN5dFGUWbTMilVsih4ia62DBRWR22gXicgJwM4ULWf5AcnWysEBwGaY+zKglArSYD31kqkFrrFddI5doPvPHPjgEvqdu0QkJ9kG/2Csu9LQhBo0rjCac8XPNBjjoj2Ai2dvA6D/uGMNOlhUNiTL5dnUY4LcDIdm1X+9J98BKUA6Kt1JvqMAAAAASUVORK5CYII=" alt="crop"></button>
        <button type="button" id="rot_l" onclick="rotate(-90);"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAAXNSR0IArs4c6QAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9wBHg4xIaQkRQ4AAAS5SURBVEjHnVZfTFNXGP+dc8+97LYrtEhpaYmlgJQuZCAGjDE6lKSQElgUpyFbosY/4WlRsvmikZHogw/bgwnZgyHxwcwnXpy4hGSK80/0ZWaOSMCQjIKIs1Ix9l7a3ttvD6POiq26LzkP597vfL/z/b5/B/hAOX78OABg27Ztjra2Nu+79Bn+hzQ1NXmLi4uvEJF/dHS0MJ8u/xDDg4ODqK2tVW022+U9e/Z8qut67E2dnp6erL3IZez8+fPYt29f1rdz585ZKioq7jY2NtZ5PB5SVXVtV1cXCSHAOf+biPqmp6d/BvDiwIEDGBoayk9RX1/fJ8vLyzuFEKiurr44PDx8sb29vWlhYYG8Xi8zDAMAUF5eTpIksXg8jqmpqT9GRkb6JiYmrg4MDOT2oLOzU3W73QM7duzYZZomzp49KwzDeDIzMwMiwsOHDyGEAGMMc3NzjIhgsVho+/bt9ZIk/WQYRri/v//3nDGwWCz+qqqqXZqmwWq1Ih6P22/dunVofHz8aiqVYqqqYnx83Hzw4MHTSCSypGkaNE3DpUuXqKGhwVVXV9fndruVnAA+n++Q3+/Ho0ePiHMOAAaA5zdv3uydnp4eMU0TkiQ9GRsb23Lnzp2vJiYmhpeWlpgQApOTkygtLe0pKSkpz0lRWVnZEbvdjvn5eUZEAEAAlgHMXL9+/Sjn3KYoSgOAyWg0OqfresRut1e6XK71yWSS0uk0NwzD9laA3t7eM83NzYjFYpBl+c3fSVmWZ69du7YXABRFUZLJZLygoGBG1/U/7927V55Op0mSJJmI0qsAnE7nxx6P52AwGKT79++zDMCKFwCAVCq1DGAWAEulUgYALC4uvrxx48ZRAN+tFHASQGwVQDgc3tve3l40OzvLhBAwTTPL+GtivgFsAogBeL6yJwCUBdDS0qIGAoFWp9MpPX78GLIsg3MOIgIR0cmTJx2yLBcmEonYqVOnXkxNTaGmpuZ1E7Sy3t4qHA6HOxAIdGmaBkVRIEkShPj3DrquL1ut1sutra1/NTc3/3bixInPampqMDY2lre9ZHkQDAa/9nq9kmmaJIRgAJBOpzO8y4lEYu2mTZsoGo3W22y2XwAMtrS0fPu+AHJRUdERn89Hz549Yyu5j3Q6naEok65sbm4Omzdv/sjj8XxTVlYWnJ+fP3j69OkFABgdHUUoFFpN0eHDh7/funUrNE1jkiQhs4QQq4JcWFiISCTCnE4ndXd3d2zYsOHusWPH9gLIMv7KA5fLVVhZWdldXV2NWCwGSZLy8qqqKjjnSCaTjHNOHR0da30+35DVam3r7+//koiIMfYfQDgc3rlx48YSXddfBTWfWCyWrKEVj8fR2NjIHQ5HT2lp6Zb9+/evBxAFABEKhQqqqqo6161bpxDRWwEytZChSlXVVTqJRIL5/X7avXt3udfrfRoIBPo0TftR2Gw2X319/c41a9Yg09+zrscY4vE4GGNMCCEBIEVRcs0RVlxcjM7OTtjt9h8uXLhwhYVCodq6urpfk8mkoBwlyzlPLy4unqmoqAgoivKFaZpm3jnMOeOcP719+/bnDIAVgB1AQZ4zBoCXmSR6j1lOABIAYuy11wV7x4EPfYkQAPoHPrTnVoRnf8MAAAAASUVORK5CYII=" alt="rotl"></button>
        <button type="button" id="rot_r" onclick="rotate(90);"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAAXNSR0IArs4c6QAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9wBHg4xC3+fjNgAAASzSURBVEjHlVZfTFNXHP7OPbe3t5fyT6kUWGhqgcZgYNbEagiO2lhNyXgoJKQZxphMwx5c2B7YgzWmmy/LMl4xZlt82p7mg3FZJHHUTaMbJDwMq2V0m8CVERprwd6O3t579rCWYP9E/ZLfw0m+8/vO728O8AqcOHGixePx1APAhQsX8KYgryL4fL4NQshfz54988/MzMhvKsDtPASDwRJCJpNJDg8Pd1VXV990Op2mycnJNxc4f/48ACAej9cEAoH3hoaG1gKBABsYGGAmk6m1ubmZHT58+G273f7b1atXpWIn165dq5yicDiMS5cu4eDBg8f6+vomOjo6us1mMzRNYysrKwQAeJ6HLMvMarWSW7duzfh8vuDTp0+Duq5DFMXrExMT0UoCNBKJoL293eX3+697PB7H7Owsi8fjRJZlsrGxgVQqhUQiAU3TkEqlyOrq6hyl1DI2Nhbu6ek5trKy0iiK4s2FhYVc2RRZrVZh//79Hx84cKDxxo0bTFEUKIqCpaWlVDQaXZ+fn9dMJhNUVSXz8/M/3bt376yqqrVmsxmKosDhcAxJkmSvWIOGhoa39uzZE4zFYuB5HqlUijx69Oj7Bw8ejEQikV5K6ZqmaYjH4z/cvXt3FMBzQojGcRxkWWZ2ux02m+1sRYFcLlet6zqXzWaZIAgkkUjMPXz48NNEIjENICYIgjkajf5y586djwA8AfAvAMYYg67rpK6uDk1NTWOVBHjGmL64uJiMxWIqx3FE07TfjUbjk3Q6nTaZTMLU1FQnAN5gMPyjqmp252WDwYBkMolDhw5hdHT08ytXrnxSIhCLxf6MxWJdAAQADEAKwIv8DGQBrAHQVVXVCpcYY9sCm5ub6OrqYs3Nze9bLJbP1tfXXxTPQRqADODvfAqSALQdHLXovC1CKQXP81heXiYnT56s9fv9p0siKPDzVoKFhQV0dHQgFArVGI3GOkppNhqNMsYYDAYDKKVIp9NoamqiTqfT29fX900kEsmUXRXFmJ6eLjh/x+12/+z1ep8YDIbZdDqdKQwgpRSCIEBRFDidzoH6+nprxV1UDI/Hg1Ao9IXX6/3R7XZ3HzlyhGUyGaZpmlAQKJimaaylpYXu27fvw3IpAgBMTU3B5/MBAEKhkNVqtX51/Pjx/tbWVvb48WNYLBaSLzBhjIHneXDc9huJzWZjtbW1YwDG87V7OYKC8/Hx8dMul+vXwcHB/t27dzNZlklNTU1JkQspKpiiKOTo0aM4d+7clyUpKrwsHA5/Ozw8/HV/f38rpZTlcjliNpthMplKh6hIQNM0tLW1Ye/evYONjY01LwmcOXOmYXJycunUqVNBl8vFKYoCQRCIKIoQRRGSJJUVKLZMJgO3293g9/sDAMBfvHhRlCTpg87Ozomenh7s2rWLbW1tkXIOC5EWjOf50v1PCNrb2wWHw/Guz+f7jl9bW2sdGRmZ6O3t3eYYjcZKjcUopYTjOCJJEqqqqranujiy7u7uwNzcnI1PJpPC/fv3n9++fTvLyrF39vT/jv8QRXH58uXLq7qul21zQggRBCG3ubnJEQBVAOrzu+h1sJGf+qriNi/CFoDnZMfvgrymAHvNXwkDwP4DRmfpUOtOVYAAAAAASUVORK5CYII=" alt="rotr"></button>
        <button type="button" id="scale" class=""><span class="glyphicon glyphicon-zoom-in" aria-hidden="true"></span></button>
        <button type="button" id="rotate"><span class="glyphicon glyphicon-repeat" aria-hidden="true"></span></button>
        <button type="button" id="select"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAAXNSR0IArs4c6QAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9wCCBMJFi0qHkoAAAOTSURBVEjHtZbLSytJHIW/7q7uJG1CkjbxleALcelCRRER3ejdC4Jw/4L5E2bldS8MuHN5kVkpZMCVwihDkFFUdK3iO4qIwWgwpl81CzHhji4ukXu2dao+zu9UQfHHX7/xqzTz5xQKwOzs7Kjrul+KxaLd398vOzs7WVtb4/b2lsbGRiYmJjg9PWV7exuAwcFBOjo63nlOTk7Y3d1VwuGwIYRYnZmZ+UcAOI7zRVXV3+PxOKZpoigKsVgM3/eJxWIoikIwGCSRSAAQDAY/9JimSTwex3VdHMcBeAU8Pj7almUxMDBAMplESklvby++76OqKkIIWlpaqK+vByAQCCCEeOdpbW0lFAqxtbXFw8ODDSAABgYGpGmaJBIJhBC4rkskEkFVVXzfx/M8DMMgFAoB4HkeUsp3HiEEiUSCnp4enp+fZQXQ0dGBqqoAuK5bOcTzvEphUsrK2pv+73lbb25uxvd9KoBMJkN9fT3Dw8NEo9F3B/2shBAUCgU2Nze5v7+vAi4uLnBdF9d1K0lqkaqquK7L7e0t19fXVUBTUxOWZaFpWiVaLfJ9H03TsCzrxxFNT0+jKAq6rtc8nrcO6urqGB8fR0rJ/Pz8K+Dg4IBwOExXVxehUKjmFKqqUiqVOD4+plgsVhOsrKyQTqdJpVJEIhFs26655FKpRDab5erq6hUKUC6XcRwHKSWKotQ8IkVRkFLiOA7lcrmaYHJyknA4jGmab0+8JjmOg2majI2NUSwWWV9ffwX09PSgqiq6rn/6Fum6TldX14+3aG5ujlQqxdTUFMlksuYODMPg7u6OpaUlcrlcFXB0dIRt2ziO8+mH5jgOp6ennJ+fV0tua2sjnU4jhEBKWTNASokQgnQ6TVtb22vxANlsdkZV1W+GYXwqwVsPtm3j+/63kZGRWQGwsbGBZVkMDQ0RDAZ5eXkhEAigaRqe51Eul9E0DcMwALBtG8/z3nne9u7v75PP56sdLC4uKqlUCsuy6O7uRkrJzc0NjuOg6zqxWIxSqcTT0xMAkUiEQCDwoefw8JDl5WVyuZwCoAG0t7dPuK47cnBwQDQaJZlMsrCwQCaT4ezsjL6+Pvb29lhYWCCbzRKPx2loaHjn2dnZ4fv375RKJXRd//fm5uZvAaDr+qpt2+RyOTufz0vP8zg/P+f6+roygkKhwOXlJQCFQoGPPPl8nlwup0SjUcMwjFUARr/Gftm3ZfRrjP8AhinRzDU5lfgAAAAASUVORK5CYII=" alt="select"></button>
      </div>
      <hr>
      <div id="drawing-properties">
        <div class="form-item">
          <label for="canv_width">{% trans "Line thickness" %}: <span id="spcanv_width">1</span></label>
          <input type="range" id="canv_width" name="canv_width" value="1" min="1" max="100">
        </div>
        <div class="form-item">
          <label for="alfa">{% trans "Opacity" %}: <span id="spalfa">1.000</span></label>
          <input type="range" id="alfa" name="alfa" value="100" min="0" max="100">
        </div>
        <div class="form-item">
          <label for="color">{% trans "Line color" %}:</label>
          <input type="color" id="color" value="#000000" name="color">
        </div>
      </div>
      <hr>
      <div id="canv-size">
      <span>{% trans "Canvas size" %}:</span>
        <div class="form-item">
          <label for="width">{% trans "width" %}:</label><input type="number" id="width" value="550">
        </div>
        <div class="form-item">
          <label for="height">{% trans "height" %}:</label><input type="number" id="height" value="550">
        </div>
        <button type="button" id="resize_canv">{% trans "Resize" %}</button>
      </div>
    </div>
    <button type="button" id="back" onclick="canv_restore();"><span class="glyphicon glyphicon-step-backward" aria-hidden="true"></span></button>
    <button type="button" id="forward" onclick="canv_forward();"><span class="glyphicon glyphicon-step-forward" aria-hidden="true"></span></button>
    <button type="button" id="clear" onclick="canv_clear();"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAAXNSR0IArs4c6QAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9wCBBYYCMjhfWoAAAP0SURBVEjHrZVNTGtFFMfPzP3qhX7Q0pCWBjRpI+ErgDEh6ALD1oWujDGunyQYVm/hW+uKEFQCIaABF76oGzbqW4CJLHDDghgLBCIB+gjQFi5Q2ts7cz/muAHCw8dXn5NMMpP5n/8v55zJDMArjoGBAfXRo0eRm86lSo0HBwdpMpn8tKam5vva2trHjY2Nsd7e3t+Xlpbwqo5WCjg+Ph7o7u4esywrp2mankwmPxJChK/rKgL09/e3tLa2fnFycsKLxeJ3tm3L+Xx+DwBK/wvANM3P4vF4MBAI+Orr6ycDgYB+eHj44/j4OL+ulSuofa2qqu+fnp6C67o0EolUra6uZqLR6Lcv0z8YYFnWu5FIJGYYBnieh6VSybZte3B6etqsGDA0NEQZYxFEdDY3Nz8ol8uEMQaICNls9oeGhoZfb4q9F8BxHF1RlD+i0aiPEBIzDIN4noeGYazFYrEnIyMj4pUAR0dHHyYSiUafzxdobm4GAMD9/X3Y2Nj4W1VV77bYO2/R6OhoiBAyoet6cHd3l6yursL29jZBREgmk++5rvvObfG3ZjA+Pt5s2/bTnp4edWdnB8vlMjDGgDGGkiRBoVD4Zmxs7JeKAJOTk00A8KylpeW1UqlEUqkUnJycQD6fx2w2SwghiIj/3FWBl5ZoamqqhjH2UyqVep0xBkIIsG0bOOdQXV0N8XgcwuEw6Lq+9mDAzMyMYhjGWFtbW4eiKOA4Dti2DYwxsCzrch8IBIBz/vaDABMTE2Rvb+9JV1fXx4qiAOccTdMEx3HQcRxERLzogRAChBDxuwCXPRgeHia5XK6/o6Pjc0opGIZByuUyyLKMlFJCKQUhBDDG0HEcIkkSuq5L751BNpv9pL29/WtVVX3pdBo8zwNEBEQEWZahUCgA5xyEEODz+UCWZWCMFe6dQaFQ+C2dTv/puu5bnZ2d/mKxiLqugxACstkscs6Bcw7hcBg454iIkE6nnycSCY1S6uXzecE5Fzf+aMvLyxYiPvP7/W82NDQkVVWlsiyTra0toJQSy7IIAJBgMAimaRJCCM7Pz3+5v79vnZ2dSUIICgDk3A7/A+jr66MLCwvSysrKwsHBwVl9fX1HLpfzhUIhME2TMMYgFApBqVQCTdNILpdbm5ubmzoPJ1fMLwD4AkCSJHBdl5qmKTKZzMri4uLPx8fHzwGgqq6ursrv9+u7u7tmKBRSgsEgzs7OfnVwcPAXAHjn072yvnyfyPWaJRIJybIspVgsagAgI6KqaVokGo1GNU2Tqqur36CUhtfX158yxgqI6AKAJ4S4MH6hD+S2G9DU1ESEEETTNKLrOiiKQmzbBsuy0LIs9DwPM5kM3ubxLyrnFRKUWdVyAAAAAElFTkSuQmCC" alt="clear"></button>
    <button type="button" id="load" onclick="canv_save();"><span class="glyphicon glyphicon-save" aria-hidden="true"></span></button>
    <button type="button" id="save" onclick="canv_save_to_server();"><span class="glyphicon glyphicon-floppy-disk" aria-hidden="true"></span></button>
    <button type="button" id="file"><span class="glyphicon glyphicon-folder-open" aria-hidden="true"></span></button><input type="file" id="files" name="files">
    <a href="{% url 'user_tool' user.username 'canvas' %}" class="button"><span class="glyphicon glyphicon-asterisk" aria-hidden="true"></span></a>
    <br>
    <div id="canv_div">
      <canvas id="canvas" width="540" height="550" class="show">{% trans "Canvas is not supported" %}</canvas>
      <img id="canv_img" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" width="540" height="550" class="show" alt="Canvas">
    </div>
    <div id="num_canv">
      <button type="button" id="canvass1" class="active" onclick="change_canvas(1);">1</button>
    </div>
    <div id="num_canv_control">
      <button type="button" id="prev" onclick="next_canvas(-1);"><span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span></button>
      <button type="button" id="next" onclick="next_canvas(+1);"><span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span></button>
      <button type="button" id="plus_canvas" onclick="plus_canvas();"><span class="glyphicon glyphicon-plus" aria-hidden="true"></span></button>
      <button type="button" id="del_canvas" onclick="del_canvas(num_canv);"><span class="glyphicon glyphicon-minus" aria-hidden="true"></span></button>
      <button type="button" id="del" onclick="del_canvas(activ_canv);"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span></button>
      <button type="button" id="play" onclick="play(1);"><span class="glyphicon glyphicon-play" aria-hidden="true"></span></button>
    </div>
    <div class="row">
      <h3>{% trans "My images" %}</h3>
      <div id="user-images"></div>
    </div>
  </div>
    <script type="text/javascript">
        function change_settings(setting) {
            switch (setting) {
                case 'canv_width':
                    ctx.lineWidth = settings[setting].value;
                    document.getElementById("spcanv_width").innerHTML = ctx.lineWidth;
                    break
                case 'alfa':
                    ctx.globalAlpha = settings[setting].value / 100;
                    document.getElementById("spalfa").innerHTML = ctx.globalAlpha.toFixed(3);
                    break
                case 'color':
                    ctx.strokeStyle = settings[setting].value;
                    break
                default:
                    for (var key in settings) {
                        change_settings[key];
                    }
                    if (tool == 'elastic') {
                        ctx.globalCompositeOperation = 'destination-out'
                    };
                    break;
            }
        }

        function resize_canv(event, width, height, x, y) {
        //  stack[activ_canv].push(canv.toDataURL());
            x = x || 0;
            y = y || 0;
            alert(width + ' ' + height + ' ' + x + ' ' + y);
            if (!isNaN(width)) {
                canv.width = width;
                canv_img.width = width;
            }
            else {
                canv.width = document.getElementById('width').value;
                canv_img.width = document.getElementById('width').value;
            }
            canv.height = height || document.getElementById('height').value;
            canv_img.height = height || document.getElementById('height').value;
            var img = new Image();
            img.src = stack[activ_canv].pop();
            img.onload = function() {
                ctx.drawImage(img, -x, -y);
                change_settings();
                ctx.lineCap = "round";
            }
        }

        function canv_clear() {
            stackF[activ_canv] = [];
            ctx.clearRect(0, 0, canv.width, canv.height);
            stack[activ_canv].push(canv.toDataURL());
        }

        function canv_restore() {
            ctx.beginPath();
            ctx.globalCompositeOperation = "source-over";
            ctx.globalAlpha = 1;
            ctx.clearRect(0, 0, canv.width, canv.height);
            stackF[activ_canv].push(stack[activ_canv][stack[activ_canv].length - 1]);
            var img = new Image();
            img.src = stack[activ_canv].pop();
            img.onload = function() {
                ctx.drawImage(img, 0, 0);
                change_settings('alfa');
            }
        }

        function canv_forward() {
            if (stackF[activ_canv].length == 0) {
                return true;
            }
            ctx.beginPath();
            ctx.globalCompositeOperation = "source-over";
            ctx.globalAlpha = 1;
            ctx.clearRect(0, 0, canv.width, canv.height);
            stack[activ_canv].push(stackF[activ_canv][stackF[activ_canv].length - 1]);
            var img = new Image();
            img.src = stackF[activ_canv].pop();
            img.onload = function() {
                ctx.drawImage(img, 0, 0);
                change_settings('alfa');
            }
        }

        // Save to file.
        function canv_save() {
            document.location.href = canv.toDataURL("image/png").replace("image/png", "image/octet-stream");
        }

        // Save on server file.
        function canv_save_to_server() {
            {% if user.is_authenticated %}
            var canv = getParameterByName('canv');

            jQuery.ajax({
                type: "POST",
                url: "{% url 'canvases' user.username %}",
                data: {
                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                    'imgBase64': canvas.toDataURL(),
                    'slug': canv
                }
            }).done(function(o) {
                console.log('saved');
            });
            {% endif %}
        }

        function change_canvas(ac) {
            ctx.clearRect(0, 0, canv.width, canv.height);
            activ_canv = ac;
            for (var i = 1; i < num_canv + 1; i++) {
                document.getElementById("canvass" + i).className = '';
            }
            document.getElementById("canvass" + ac).className = 'active';
            var img = new Image();
            img.src = stack[ac][stack[ac].length - 1];
            ctx.drawImage(img, 0, 0);
        }

        function plus_canvas() {
            num_canv += 1;
            div_num.innerHTML += '<button type="button" id = "canvass' + num_canv + '"' + ' onclick="change_canvas(' + num_canv + ');">' + num_canv + '</button> ';
            stack[num_canv] = [];
            stackF[num_canv] = [];
            stack[num_canv].push(stack[num_canv - 1][stack[num_canv - 1].length - 1]);
        }

        function del_canvas(dc) {
            var num = document.getElementById("canvass" + num_canv);
            num.parentNode.removeChild(num);
            stack.splice(dc, 1);
            stackF.splice(dc, 1);
            if (activ_canv == num_canv) {
                activ_canv = activ_canv - 1;
            }
            num_canv -= 1;
            change_canvas(activ_canv);
        }

        function play(a) {
            if (a < num_canv + 1) {
                setTimeout(function() {
                    change_canvas(a);
                    play(a + 1)
                }, 1000);
            }
        }

        function next_canvas(ac) {
            ac += activ_canv;
            if (ac < 1) {
                ac = num_canv;
            }
            if (ac > num_canv) {
                ac = 1;
            }
            change_canvas(ac);
        }

        function showfile(evt) {
            ctx.globalCompositeOperation = "source-over";
            ctx.globalAlpha = 1;
            var f = evt.target.files[0];
            if (!f.type.match('image.*')) {
                return true;
            }
            var reader = new FileReader();
            reader.onload = (function(theFile) {
                return function(e) {
                    var img = new Image();
                    img.src = e.target.result;
                    ctx.drawImage(img, 0, 0);
                    stack[activ_canv].push(canv.toDataURL());
                    if (stack[1].length < 3 && num_canv == 1) {
                        resize_canv(img.width, img.height);
                    }
                    change_settings('alfa');
                };
            })(f);
            reader.readAsDataURL(f);
        }

        function paste() {
            var items = document.clipboardData.items;

            console.log(JSON.stringify(items));  // will give you the mime types
            var blob = items[0].getAsFile();
            var reader = new FileReader();
            reader.onload = function(event) {
                console.log(event.target.result);  // data url!
            }
            reader.readAsDataURL(blob);
        }

        function change_tool(active_tool) {
            draw = false;
            tool = active_tool || tool;
            ctx.globalCompositeOperation = 'source-over';
            switch (tool) {
                case 'pencil':
                    canv.onmousedown = pencil_draw_begin;
                    canv.onmousemove = pencil_draw_go;
                    canv.onmouseup = pencil_draw_end;
                    break
                case 'elastic':
                    ctx.globalCompositeOperation = 'destination-out';
                    canv.onmousedown = pencil_draw_begin;
                    canv.onmousemove = pencil_draw_go;
                    canv.onmouseup = pencil_draw_end;
                    break
                case 'line':
                    canv.onmousedown = get_point;
                    canv.onmousemove = line_draw;
                    canv.onmouseup = draw_end;
                    break
                case 'polyline':
                    draw = true;
                    ctx.beginPath();
                    canv.onmousedown = polyline;
                    canv.onmousemove = null;
                    canv.onmouseup = null;
                    break
                case 'rectangle':
                    canv.onmousedown = get_point;
                    canv.onmousemove = rect_draw;
                    canv.onmouseup = draw_end;
                    break
                case 'circle':
                    canv.onmousedown = get_point;
                    canv.onmousemove = circle_draw;
                    canv.onmouseup = draw_end;
                    break
                case 'pipette':
                    canv.onmousedown = pipette;
                    canv.onmousemove = null;
                    canv.onmouseup = null;
                    break
                case 'fill':
                    canv.onmousedown = filled;
                    canv.onmousemove = null;
                    canv.onmouseup = null;
                    break
                case 'pan':
                    canv.onmousedown = get_point;
                    canv.onmousemove = pan;
                    canv.onmouseup = pan_end;
                    break
                case 'crop':
                    canv.onmousedown = get_point;
                    canv.onmousemove = null;
                    canv.onmouseup = crop;
                    break
                case 'scale':
                    canv.onmousedown = get_point;
                    canv.onmousemove = scale_go;
                    canv.onmouseup = scale_end;
                    break
                default:
                    change_tool (tool);
                    break;
            }
            for (var key in tools)
                tools[key].className = '';
            tools[tool].className = 'active';
            ctx.save();
        }

        function pencil_draw_begin(event) {
            stackF[activ_canv] = [];
            draw = true;
            ctx.beginPath();
            ctx.moveTo((event.offsetX || (event.layerX - canv.offsetLeft)),(event.offsetY || (event.layerY - canv.offsetTop)));
        }

        function pencil_draw_go(event) {
            if (!draw) {return true;};
            ctx.lineTo((event.offsetX || (event.layerX - canv.offsetLeft)),(event.offsetY || (event.layerY - canv.offsetTop)));
            ctx.stroke();
            ctx.save();
            ctx.moveTo((event.offsetX || (event.layerX - canv.offsetLeft)),(event.offsetY || (event.layerY - canv.offsetTop)));
        }

        function pencil_draw_end(event) {
            if (!draw) {return true;};
            ctx.lineTo((event.offsetX || (event.layerX - canv.offsetLeft)),(event.offsetY || (event.layerY - canv.offsetTop)));
            ctx.stroke();
            ctx.save();
            draw = false;
            stack[activ_canv].push(canv.toDataURL());
        }

        function line_draw(event) {
            if (!draw) {return true;};
            ctx.beginPath();
            ctx.moveTo(x1, y1);
            ctx.lineTo((event.offsetX || (event.layerX - canv.offsetLeft)),(event.offsetY || (event.layerY - canv.offsetTop)));
            ctx.stroke();
        }

        function polyline(event) {
            stackF[activ_canv] = [];
            ctx.lineTo((event.offsetX || (event.layerX - canv.offsetLeft)),(event.offsetY || (event.layerY - canv.offsetTop)));
            ctx.stroke();
            ctx.save();
            ctx.moveTo((event.offsetX || (event.layerX - canv.offsetLeft)),(event.offsetY || (event.layerY - canv.offsetTop)));
            stack[activ_canv].push(canv.toDataURL());
        }

        function get_point(event) {
            stackF[activ_canv] = [];
            x1=(event.offsetX || (event.layerX - canv.offsetLeft));
            y1=(event.offsetY || (event.layerY - canv.offsetTop));
            draw = true;
            switch (tool) {
                case 'line':
                case 'rectangle':
                case 'circle':
                    stack[activ_canv].push(canv.toDataURL());
                    canv_img.src = stack[activ_canv].pop();
                    ctx.globalCompositeOperation = "copy";
                    break
                case 'scale':
                    ctx.save();
                    ctx.globalAlpha = 1;
                    ctx.translate(x1, y1);
                    ctx.globalCompositeOperation = "copy";
                    break
                case 'pan':
                    ctx.globalAlpha = 1;
                    ctx.globalCompositeOperation = "copy";
                    break
                default:
        //          ctx.beginPath();;
                    break;
            }
        }

        function draw_end(event) {
            if (!draw) {
                return true;
            }
            ctx.globalCompositeOperation = "destination-over";
            ctx.globalAlpha = 1;
            var img = new Image();
            img.src = canv_img.src;
            img.onload = function() {
                ctx.drawImage(img, 0, 0);
                change_settings('alfa');
                canv_img.src = '';
                stack[activ_canv].push(canv.toDataURL());
                change_tool ();
            }
            draw = false;
            ctx.save();
        }

        function rect_draw(event) {
            if (!draw) {return true;};
            var x2 = (event.offsetX || (event.layerX - canv.offsetLeft));
            var y2 = (event.offsetY || (event.layerY - canv.offsetTop));
            ctx.strokeRect(x1, y1, x2 - x1, y2 - y1);
        }

        function circle_draw(event) {
            if (!draw) {return true;};
            ctx.beginPath();
            var x2=(event.offsetX || (event.layerX - canv.offsetLeft));
            var y2=(event.offsetY || (event.layerY - canv.offsetTop));
            ctx.arc(x1, y1, Math.sqrt((x1 - x2) * (x1 - x2) + (y1 - y2) * (y1 - y2)), 0, 2 * Math.PI, true);
            ctx.stroke();
        }

        function pipette(event) {
            var x = (event.offsetX || (event.layerX - canv.offsetLeft));
            var y = (event.offsetY || (event.layerY - canv.offsetTop));
            var imgd = ctx.getImageData(x, y, 1, 1);
            var pix = imgd.data;
            var decColor = pix[2] + 256 * pix[1] + 65536 * pix[0];
            var str=decColor.toString(16);
            while (str.length < 6) {
                str = '0' + str;
            };
            settings['color'].value = '#' + str;
            ctx.strokeStyle = '#' + str;
        }

        function pan(event) {
            if (!draw) {return true;};
            var x2 = event.offsetX || (event.layerX - canv.offsetLeft);
            var y2 = event.offsetY || (event.layerY - canv.offsetTop);
            var img = new Image();
            img.src = stack[activ_canv][stack[activ_canv].length - 1];
            img.onload = function() {
                ctx.drawImage(img, x2 - x1, y2 - y1);
            }
        }

        function pan_end() {
            stack[activ_canv].push(canv.toDataURL());
            ctx.globalAlpha = settings['alfa'].value / 100;
            draw = false;
        }

        function crop(event) {
            if (!draw) {return true;};
            stackF[activ_canv] = [];
            var x2 = event.offsetX || (event.layerX - canv.offsetLeft);
            var y2 = event.offsetY || (event.layerY - canv.offsetTop);
            resize_canv('', Math.abs(x1 - x2), Math.abs(y1 - y2), Math.min(x1, x2), Math.min(y1, y2));
            draw = false;
        }

        function scale(x, y) {
            ctx.save();
            ctx.globalAlpha = 1;
            ctx.globalCompositeOperation = "source-over";
            stackF[activ_canv] = [];
            stack[activ_canv].push(canv.toDataURL());
            ctx.clearRect(0, 0, canv.width, canv.height);
            ctx.translate(canv.width * (1 - x) / 2, canv.height * (1 - y) / 2);
            ctx.scale(x, y);
            var img = new Image();
            img.src = stack[activ_canv].pop();
            img.onload = function() {
                ctx.drawImage(img, 0, 0);
                stack[activ_canv].push(canv.toDataURL());
                ctx.restore();
            }
        }

        function scale_go() {
            if (!draw) {
                return true;
            }
            var x2 = (event.offsetX || (event.layerX - canv.offsetLeft));
            var y2 = (event.offsetY || (event.layerY - canv.offsetTop));
            var scale_factor = 6 * (Math.sqrt((x2 - x1) * (x2 - x1) / (canv.width * canv.width) + (y2 - y1) * (y2 - y1) / (canv.height * canv.height)));
            var img = new Image();
            img.src = stack[activ_canv][stack[activ_canv].length - 1];
            img.onload = function() {
                ctx.drawImage(img, -x1 * scale_factor, -y1 * scale_factor, scale_factor * canv.width, scale_factor * canv.height);
            }
        }

        function scale_end() {
            ctx.restore();
            stack[activ_canv].push(canv.toDataURL());
            draw = false;
        }

        function rotate(x) {
            ctx.save();
            ctx.globalAlpha = 1;
            ctx.globalCompositeOperation = "source-over";
            stackF[activ_canv] = [];
            stack[activ_canv].push(canv.toDataURL());
            ctx.clearRect(0, 0, canv.width, canv.height);
            ctx.translate(canv.width / 2, canv.height / 2);
            ctx.rotate(x / 180 * Math.PI);
            var img = new Image();
            img.src = stack[activ_canv].pop();
            img.onload = function() {
                ctx.drawImage(img, -canv.width / 2, -canv.height / 2);
                change_settings('alfa');
                stack[activ_canv].push(canv.toDataURL());
                ctx.restore();
            }
        }

        function filled(event) {
            stackF[activ_canv] = [];
            d0 = new Date();
            var x = (event.offsetX || (event.layerX - canv.offsetLeft));
            var y = (event.offsetY || (event.layerY - canv.offsetTop));
            old_pix = ctx.getImageData(x, y, 1, 1);
            new_pix = ctx.createImageData(1, 1);
                new_pix.data[0] = parseInt(ctx.strokeStyle.substring(1, 3), 16);
                new_pix.data[1] = parseInt(ctx.strokeStyle.substring(3, 5), 16);
                new_pix.data[2] = parseInt(ctx.strokeStyle.substring(5, 7), 16);
                new_pix.data[3] = parseInt(ctx.globalAlpha*255);
            ctx.beginPath();
            fillPixel(x, y);

            var i = 0;

            while(stack_pix.length > 0) {
                i++;
                toFill = stack_pix.pop();
                fillPixel(toFill[0], toFill[1]);
                ctx.stroke();
            }

            ctx.stroke();
            stack[activ_canv].push(canv.toDataURL());
            d1 = new Date();
            alert('Filling took: ' + (d1 - d0) / 1000 + ' s');
        }

        function fillPixel(x, y) {
            if (!alreadyFilled(x, y)) {
                ctx.putImageData(new_pix, x, y);
            }

            if (!alreadyFilled(x,   y-1)) stack_pix.push([x,   y-1]);
            if (!alreadyFilled(x+1, y  )) stack_pix.push([x+1, y  ]);
            if (!alreadyFilled(x,   y+1)) stack_pix.push([x,   y+1]);
            if (!alreadyFilled(x-1, y  )) stack_pix.push([x-1, y  ]);
        }

        function alreadyFilled(x, y) {
            var pix=ctx.getImageData(x, y, 1, 1);

            return ((pix.data[0]==new_pix.data[0] && pix.data[1]==new_pix.data[1] && pix.data[2]==new_pix.data[2] && pix.data[3]==new_pix.data[3])
                || (pix.data[0]!=old_pix.data[0] || pix.data[1]!=old_pix.data[1] || pix.data[2]!=old_pix.data[2] || pix.data[3]!=old_pix.data[3])
                || (x == -1 || y==-1 || x==canv.width || y==canv.height));
        }

        /*
        for (var x = 0; x < canvasData.width; x++) {
            for (var y = 0; y < canvasData.height; y++) {

                // Index of the pixel in the array
                var idx = (x + y * width) * 4;

                // If you want to know the values of the pixel
                var r = canvasData.data[idx + 0];
                var g = canvasData.data[idx + 1];
                var b = canvasData.data[idx + 2];
                var a = canvasData.data[idx + 3];

                //[...] do what you want with these values

                // If you want to update the values of the pixel
                canvasData.data[idx + 0] = ...; // Red channel
                canvasData.data[idx + 1] = ...; // Green channel
                canvasData.data[idx + 2] = ...; // Blue channel
                canvasData.data[idx + 3] = ...; // Alpha channel
            }
        }
        */

        canv = document.getElementById("canvas");
        canv_img = document.getElementById("canv_img");
        ctx = canv.getContext("2d");
        ctx.lineCap = "round";
        div_num = document.getElementById("num_canv");
        num_canv = 1;
        activ_canv = 1;
        stack = [];
        stackF = [];
        stack[1] = [];
        stackF[1] = [];
        stack_pix = [];

        tools = {
            'pencil'            :   document.getElementById("pencil"),
            'elastic'           :   document.getElementById("elastic"),
            'line'              :   document.getElementById("line"),
            'polyline'          :   document.getElementById("polyline"),
            'rectangle'         :   document.getElementById("rectangle"),
            'circle'            :   document.getElementById("circle"),
            'pipette'           :   document.getElementById("pipette"),
            'fill'              :   document.getElementById("fill"),
            'pan'               :   document.getElementById("pan"),
            'crop'              :   document.getElementById("crop"),
            'scale'             :   document.getElementById("scale"),
        //      "rotate"    :   document.getElementById("rotate")
        };

        for (var key in tools) {
            (function(key) {
                tools[key].onclick = function() {
                    change_tool(key);
                }
            })(key);
        }

        change_tool('pencil');

        settings = {
            'canv_width'        : document.getElementById("canv_width"),
            'alfa'              : document.getElementById("alfa"),
            'color'             : document.getElementById("color"),
        };

        for (var key in settings) {
            (function(key) {
                settings[key].onchange = function() {
                    change_settings(key);
                }
            })(key);
        }

        document.getElementById('files').addEventListener('change', showfile, false);
        document.getElementById('resize_canv').addEventListener('click', resize_canv, false);

        function getParameterByName(name, url) {
            if (!url) {
                url = window.location.href;
            }
            name = name.replace(/[\[\]]/g, "\\$&");
            var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)");
            var results = regex.exec(url);

            if (!results) {
                return null;
            }
            if (!results[2]) {
                return '';
            }
            return decodeURIComponent(results[2].replace(/\+/g, " "));
        }

        function init_app() {
            var canv = getParameterByName('canv');

            if (canv) {
                $.getJSON("/canvas/" + canv, function(data) {
                    stack[activ_canv].push(data);
                    canv_restore();
                });
            }

            {% if user.is_authenticated %}
            $.getJSON("{% url 'canvases' user.username %}", function(data) {
                var items = [];
                $.each(data, function(key, val) {
                    items.push(
                        '<div class="col-sm-4" style="">' +
                            '<img src="' + val + '" style="max-width: 100%; border: 2px solid black; border-radius: 5px;" />' +
                            '<a class="ajax-link" href="{% url 'tool' 'canvas' %}?canv=' + key + '">' + key + '</a>' +
                        '</div>'
                    );
                });

                $(items.join('')).appendTo("#user-images");
            });
            {% endif %}
        }

        if ("undefined" == typeof jQuery) {
            window.onload = function() {
                init_app();
            };
        }
        else {
            init_app();
        }
    </script>
{% endblock %}
